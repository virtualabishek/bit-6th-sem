That's a vital block of content for your theoretical and practical success! Performance tuning is central to the DBA role.

First, let's quickly review the last drill to ensure those core concepts are solid:

### **Review: Database Maintenance Drill**

1.  **Transient Performance Spike Tool:** The best tool to investigate a short, transient performance spike (like 15 minutes) is the **Active Session History (ASH)**. ASH stores sampled data in a circular buffer within the **SGA**.
2.  **ADDM Recommendation:** The **Automatic Database Diagnostic Monitor (ADDM)** detects performance problems (like high CPU from a complex query) by analyzing AWR snapshots. ADDM would recommend running the **SQL Tuning Advisor (STA)** on the high-load SQL.
3.  **Comparison Features:** To compare the slow 15 minutes against a known good baseline, you need to use **AWR Baselines** (which are identified by a range of snapshots that are preserved for comparison) and **AWR Snapshots** (the mechanism for gathering the historical data).

If you were confident in those answers, you've mastered the automatic monitoring tools! Now, let's break down SQL Tuning.

---

## Unit 7.1: SQL Tuning and Optimization

### I. The Oracle Optimizer and Execution Plans

The Oracle **Query Optimizer** (often referred to as the **Cost-Based Optimizer or CBO**) is built-in database software that determines the most efficient method for a SQL statement to access requested data.

| Concept | Description | Source |
| :--- | :--- | :--- |
| **Goal of Optimizer** | To select the **Execution Plan** with the **lowest estimated cost** among all potential options, calculating cost based on factors like I/O, CPU usage, and communication. | |
| **Execution Plan** | The sequence of operations the database performs to execute a SQL statement. It outlines the recommended approach to fulfill the SQL statement's requirements. | |
| **Tuning Goal** | The primary goal of tuning is to reduce **DB time**, which is the cumulative time spent processing user requests (wait time + CPU time of non-idle sessions). | |

### II. SQL Plan Control Features (Advanced Optimization)

These features allow the database to guide or modify the execution plan beyond traditional CBO estimates.

#### A. SQL Plan Directives
A SQL plan directive provides the optimizer with extra guidance to create a more efficient execution plan.
*   **Purpose:** Serves as a reminder to the optimizer that it might be misjudging the cardinalities of specific types of predicates.
*   **Generation:** Directives are automatically generated through automatic reoptimization when **cardinality misestimates** occur during SQL execution.
*   **Scope:** They are not specific to individual SQL statements but can be applied to similar queries with matching patterns.

#### B. Adaptive Execution Plans
The Adaptive Execution Plan feature allows the optimizer to dynamically adjust execution plans during runtime based on the actual runtime statistics and conditions encountered during query execution.
*   **Mechanism:** An adaptive query plan incorporates predefined subplans and an **optimizer statistics collector**. The collector gathers runtime statistics (like cardinality/histograms).
*   **Selection:** As the query executes, the dynamic plan coordinator gathers statistics and dynamically selects the optimal subplan.

### III. SQL Advisors and Automatic Tuning

#### A. SQL Tuning Advisor (STA)
The STA analyzes SQL statements and provides tuning recommendations.

| Feature | Description | Source |
| :--- | :--- | :--- |
| **Input Sources** | Typically run in response to an ADDM finding. Other sources include AWR snapshots, the shared SQL area, and SQL Tuning Sets (STS). | |
| **Recommendations** | Advice includes collecting statistics, creating indexes, restructuring SQL statements, or creating a **SQL Profile**. | |
| **Output** | Provides advice on optimizing the execution plan, a **rationale** for the proposed optimization, the estimated performance **benefit**, and the SQL command to implement the advice. | |

#### B. Automatic SQL Tuning Results and Implementation
**Automatic SQL Tuning** runs automatically as a maintenance task during defined windows.

| Action | Rule | Source |
| :--- | :--- | :--- |
| **Profiling/Implementation** | The feature can be configured to automatically implement **SQL Profile** recommendations. | |
| **Implementation Threshold** | SQL Profiles are automatically implemented **only if** the performance improvement is estimated to be at least **threefold** (i.e., over 66% benefit). | |
| **Other Recommendations** | Recommendations such as creating new indexes, refreshing statistics, or restructuring SQL **must be implemented manually** by the DBA. | |

### IV. Practical Code: Cancel a SQL Statement

Since Oracle 18c, you can cancel a specific SQL statement without terminating the entire session. This is preferred over using `KILL SESSION`, which disconnects the user entirely.

| Action | SQL Command Syntax | Source |
| :--- | :--- | :--- |
| **Cancel a specific SQL statement** | `ALTER SYSTEM CANCEL SQL 'SID, SERIAL, SQL_ID';` | |
| **Cancel the current SQL statement** | `ALTER SYSTEM CANCEL SQL 'SID, SERIAL';` | |
| **Terminate the entire session** | `ALTER SYSTEM KILL SESSION 'SID, SERIAL';` | |
| **Monitoring status** | Terminated sessions are marked as "KILLED" in `V$SESSION`. | |

---

## Exam Practice Drill: SQL Tuning

Test your knowledge on the distinction between session and SQL statement termination and the automated tools.

**Question:**

A crucial batch job running in session `123, 456` begins executing a high-load query with `SQL_ID 'abc'`, causing severe system slowness.

1.  Which diagnostic tool (ADDM or ASH) is the primary input source that automatically recommends running the SQL Tuning Advisor?
2.  Write the single SQL command you should execute to immediately halt the execution of the problematic query (`SQL_ID 'abc'`) **without** forcing the user session `123, 456` to disconnect.
3.  If the Automatic SQL Tuning task analyzes this query later and recommends creating a SQL Profile with a potential **50% benefit** (meaning the new time is half the old time), will the database automatically implement this SQL Profile during the maintenance window? Why or why not?

Provide your answers, and we'll immediately move on to the final topics once verified!