That's an excellent transition! **Undo Management** is one of the most critical topics for the exam, especially regarding read consistency and recovery.

Here is a focused guide covering all aspects of Unit 5.2, including the theoretical foundation and the necessary commands.

## Unit 5.2: Undo Management

### I. Undo Data Overview (Theoretical Foundation)

**Undo data** (historically called rollback data) is pre-modified data recorded for transactions that change the database.

#### Purpose of Undo Data:
1.  **Rollback Operations:** Allows transactions to be reversed (undone) if a `ROLLBACK` command or error occurs.
2.  **Read Consistency:** Provides the **"before image"** of data to long-running queries, ensuring a user sees a consistent view of the data as it existed when their query started, even while other transactions are modifying it.
3.  **Recovery:** Used during instance and media recovery to undo uncommitted changes applied from the redo log files to the data files.
4.  **Flashback Features:** Supports features like Flashback Query and Flashback Table, allowing users to view or recover data to a previous point in time.

#### Undo Management Mode
Oracle strongly recommends and defaults to **Automatic Undo Management (AUM)**.
*   **AUM Status:** Enabled by setting `UNDO_MANAGEMENT = AUTO`.
*   **Location:** Undo data is stored in dedicated **Undo Tablespaces**, which contain data files.
*   **Default:** When created via DBCA, the database automatically creates an auto-extending undo tablespace named `UNDOTBS1`.

### II. Monitor and Administer Undo (Practical Commands & Views)

#### A. Viewing Configuration
You can check the current settings for undo management using `SHOW PARAMETERS`:

```sql
-- View current settings for undo management and retention
SHOW PARAMETERS undo; 
-- This displays UNDO_MANAGEMENT, UNDO_RETENTION, and UNDO_TABLESPACE.

-- View file information for a specific undo tablespace (e.g., UNDOTBS1)
SELECT 
    tablespace_name, 
    file_name, 
    bytes/1024/1024 AS size_MB, 
    maxbytes /1024/1024 AS max_size_MB
FROM dba_data_files 
WHERE tablespace_name = 'UNDOTBS1';
```

#### B. Creation and Management
You can explicitly create an undo tablespace using `CREATE UNDO TABLESPACE`:

```sql
CREATE UNDO TABLESPACE UNDOTBS2 
DATAFILE '/path/to/undo02.dbf' SIZE 500M 
AUTOEXTEND ON NEXT 10M MAXSIZE UNLIMITED; -- Recommended size/extension settings
```

To add space or manage files for an existing undo tablespace:

```sql
-- Add a new datafile
ALTER TABLESPACE UNDOTBS1 ADD DATAFILE '/path/to/undo0102.dbf' 
AUTOEXTEND ON NEXT 1M MAXSIZE UNLIMITED;
```

### III. Configure Undo Retention

The **undo retention period** is the minimum time (in seconds) that Oracle attempts to keep old undo information before marking it as expired and available for overwrite.

#### 1. Specifying the Retention Period

You set the minimum retention period using the `UNDO_RETENTION` initialization parameter.

```sql
-- Set minimum undo retention to 1 hour (3600 seconds)
ALTER SYSTEM SET UNDO_RETENTION = 3600 SCOPE=BOTH; 
```

#### 2. Retention Period for Flashback Queries

The success of Flashback Query relies on retaining undo data. If Flashback operations result in `snapshot too old` errors, it means the retention period was too short. You should set `UNDO_RETENTION` to the duration of the longest expected Flashback operation.

#### 3. Guarantee Undo Retention

By default, when space is low, the database may overwrite unexpired undo data (reducing actual retention). To enforce the retention period, use the `RETENTION GUARANTEE` clause.

*   **Behavior:** When enabled, the database never overwrites unexpired undo data, **even if it causes DML transactions to fail** due to insufficient space.
*   **Command:**

```sql
-- Enable retention guarantee (use caution)
ALTER TABLESPACE UNDOTBS1 RETENTION GUARANTEE;

-- Disable retention guarantee
ALTER TABLESPACE UNDOTBS1 RETENTION NOGUARANTEE;
```

### IV. Undo Advisor, Sizing, and Fixed Size Tablespaces

#### 1. Use the Undo Advisor
The **Undo Advisor** relies on Automatic Workload Repository (AWR) data for analysis and is used to estimate the necessary size of the undo tablespace and recommend retention settings.

*   **Access:** Available through Oracle Enterprise Manager Database Express (EM Express) or the `DBMS_ADVISOR` PL/SQL package.
*   **Goal:** To determine the minimum required size based on the longest expected query duration or Flashback operation interval.

#### 2. Size the Undo Tablespace & Alter to a Fixed Size
If you change an undo tablespace from auto-extending to a **fixed size**, the database tunes the retention period based on the fixed size and activity, often achieving a longer retention than the longest active query.

To convert an auto-extending undo tablespace file to a fixed size (e.g., 300MB):

```sql
-- Step 1: Resize the datafile to the desired capacity 
ALTER DATABASE DATAFILE '/path/to/undotbs.dbf' RESIZE 300M;

-- Step 2: Disable auto-extend to make the size fixed
ALTER DATABASE DATAFILE '/path/to/undotbs.dbf' AUTOEXTEND OFF;
```
Note: You must choose a sufficiently large size; otherwise, DML could fail due to lack of undo space, or long-running queries could fail with `snapshot too old`.

### V. Switch Undo Tablespaces

An Oracle instance can have only one active undo tablespace at a time. To switch the active tablespace, set the `UNDO_TABLESPACE` parameter:

```sql
-- Example: Switch from the currently active undo tablespace to UNDOTBS2
ALTER SYSTEM SET UNDO_TABLESPACE = UNDOTBS2 SCOPE=BOTH; 
```

---

## Final Practice Drill

Let's revisit the DML contention problem from the previous unit, but now focus on the solution related to undo data:

**Question:**

A crucial, long-running batch job that performs nightly reporting often fails with the error `ORA-01555: snapshot too old`.

1.  Explain, citing the purpose of undo data, why this error occurs.
2.  Assuming the underlying undo tablespace (`UNDOTBS1`) is currently auto-extending, what is the single, immediate SQL command a DBA should execute to maximize the chance of the reporting job completing successfully on subsequent runs, without risking DML failure for smaller, concurrent transactions?
3.  If the DBA were to enable `RETENTION GUARANTEE` on `UNDOTBS1`, what critical failure could occur that would not happen if the guarantee were disabled?

Ready for your response!
